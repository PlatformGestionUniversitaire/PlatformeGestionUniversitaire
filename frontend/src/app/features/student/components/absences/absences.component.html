<div class="absences-container">
  <!-- Header -->
  <div class="absences-header">
    <h2>Mes Absences</h2>
    <p>Consultez vos absences et soumettez des demandes de justification</p>
  </div>

  <!-- Statistics Overview -->
  <div class="absences-stats">
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-content">
        <h3>{{ getAbsenceStats().total }}</h3>
        <p>Total Absences</p>
      </div>
    </div>
    <div class="stat-card success">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <h3>{{ getAbsenceStats().justified }}</h3>
        <p>Justifi√©es</p>
      </div>
    </div>
    <div class="stat-card danger">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-content">
        <h3>{{ getAbsenceStats().unjustified }}</h3>
        <p>Non Justifi√©es</p>
      </div>
    </div>
    <div class="stat-card warning">
      <div class="stat-icon">‚è≥</div>
      <div class="stat-content">
        <h3>{{ getAbsenceStats().pending }}</h3>
        <p>En Attente</p>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-buttons">
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'all'"
        (click)="onFilterChange('all')">
        Toutes
      </button>
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'justified'"
        (click)="onFilterChange('justified')">
        Justifi√©es
      </button>
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'unjustified'"
        (click)="onFilterChange('unjustified')">
        Non Justifi√©es
      </button>
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'pending'"
        (click)="onFilterChange('pending')">
        En Attente
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-spinner" *ngIf="loading">
    <div class="spinner"></div>
    <p>Chargement des absences...</p>
  </div>

  <!-- Absences List -->
  <div class="absences-section" *ngIf="!loading">
    <h3>
      Liste des Absences
      <span class="absences-count">({{ filteredAbsences.length }} absences)</span>
    </h3>

    <div class="absences-grid" *ngIf="filteredAbsences.length > 0">
      <div class="absence-card" *ngFor="let absence of filteredAbsences">
        <div class="absence-header">
          <div class="absence-date">
            <div class="day">{{ absence.date | date:'dd' }}</div>
            <div class="month">{{ absence.date | date:'MMM' | uppercase }}</div>
          </div>
          <div class="absence-info">
            <h4>{{ absence.courseName }}</h4>
            <p class="absence-type">Absence de cours</p>
            <p class="absence-time">{{ absence.startTime }} - {{ absence.endTime }}</p>
          </div>
          <div class="absence-status">
            <span class="status-badge" 
                  [class]="absence.isJustified ? 'justified' : 'unjustified'">
              {{ absence.isJustified ? 'Justifi√©e' : 'Non Justifi√©e' }}
            </span>
          </div>
        </div>

        <div class="absence-details" *ngIf="absence.teacherName">
          <p><strong>Enseignant:</strong> {{ absence.teacherName }}</p>

        </div>

        <!-- Excuse Information -->
        <div class="excuse-info" *ngIf="getExcuseForAbsence(absence.id) as excuse">
          <div class="excuse-status">
            <span class="excuse-badge" [class]="getStatusClass(excuse.status)">
              {{ getStatusDisplay(excuse.status) }}
            </span>
            <span class="excuse-date">Soumise le {{ excuse.submittedAt | date:'dd/MM/yyyy' }}</span>
          </div>
          <p class="excuse-reason">{{ excuse.reason }}</p>
          <div class="excuse-review" *ngIf="excuse.reviewDate">
            <p><strong>R√©vis√©e le:</strong> {{ excuse.reviewDate | date:'dd/MM/yyyy' }}</p>
            <p *ngIf="excuse.reviewedBy"><strong>Par:</strong> {{ excuse.reviewedBy }}</p>
            <p *ngIf="excuse.reviewComment" class="review-comment">{{ excuse.reviewComment }}</p>
          </div>
        </div>

        <!-- Action Button -->
        <div class="absence-actions">
          <button 
            class="excuse-btn"
            *ngIf="canRequestExcuse(absence)"
            (click)="openExcuseModal(absence)">
            <span class="btn-icon">üìù</span>
            Demander une Justification
          </button>
          <div class="excuse-status-info" *ngIf="!canRequestExcuse(absence) && !absence.isJustified">
            <span class="info-text">Demande d√©j√† soumise ou en cours</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredAbsences.length === 0 && !loading">
      <div class="empty-icon">üìÖ</div>
      <h3>Aucune absence trouv√©e</h3>
      <p>Aucune absence ne correspond aux crit√®res s√©lectionn√©s.</p>
    </div>
  </div>
</div>

<!-- Excuse Modal -->
<div class="modal-overlay" *ngIf="showExcuseModal" (click)="closeExcuseModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Demande de Justification</h3>
      <button class="close-btn" (click)="closeExcuseModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="absence-details" *ngIf="selectedAbsence">
        <h4>D√©tails de l'Absence</h4>
        <p><strong>Cours:</strong> {{ selectedAbsence.courseName }}</p>
        <p><strong>Date:</strong> {{ selectedAbsence.date | date:'dd/MM/yyyy' }}</p>
        <p><strong>Heure:</strong> {{ selectedAbsence.startTime }} - {{ selectedAbsence.endTime }}</p>
      </div>

      <form [formGroup]="excuseForm" (ngSubmit)="submitExcuse()">
        <div class="form-group">
          <label for="reason">Motif de l'absence *</label>
          <textarea 
            id="reason"
            formControlName="reason"
            placeholder="Expliquez la raison de votre absence (minimum 10 caract√®res)"
            rows="4">
          </textarea>
          <div class="error-message" *ngIf="excuseForm.get('reason')?.invalid && excuseForm.get('reason')?.touched">
            <span *ngIf="excuseForm.get('reason')?.errors?.['required']">Le motif est requis</span>
            <span *ngIf="excuseForm.get('reason')?.errors?.['minlength']">Le motif doit contenir au moins 10 caract√®res</span>
          </div>
        </div>

        <div class="form-group">
          <label for="document">Document justificatif (optionnel)</label>
          <input 
            type="file"
            id="document"
            formControlName="document"
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
          <small class="file-help">Formats accept√©s: PDF, Image, Document Word</small>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-btn" (click)="closeExcuseModal()">
            Annuler
          </button>
          <button 
            type="submit" 
            class="submit-btn"
            [disabled]="excuseForm.invalid || submittingExcuse">
            <span *ngIf="submittingExcuse" class="loading-text">Envoi en cours...</span>
            <span *ngIf="!submittingExcuse">Soumettre la Demande</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
